// RUN-DISABLED: stablehlo-translate --deserialize %s.0_9_0.bc | stablehlo-opt -inline | stablehlo-translate --interpret
// RUN: diff <(stablehlo-translate --deserialize %s.0_9_0.bc | stablehlo-opt) <(stablehlo-opt %s)
// RUN: diff <(stablehlo-translate --serialize --target=current %s | stablehlo-translate --deserialize | stablehlo-opt) <(stablehlo-opt %s)

module @jit_testcase {
  func.func public @main() -> tensor<i1> {
    %0:2 = call @inputs() : () -> (tensor<7x3x4xf32>, tensor<7x4xf32>)
    %1 = call @expected() : () -> tensor<7x3xf32>
    %2 = "stablehlo.dot_general"(%0#0, %0#1) {dot_dimension_numbers = #stablehlo.dot<lhs_batching_dimensions = [0], rhs_batching_dimensions = [0], lhs_contracting_dimensions = [2], rhs_contracting_dimensions = [1]>} : (tensor<7x3x4xf32>, tensor<7x4xf32>) -> tensor<7x3xf32>
    %3 = stablehlo.custom_call @check.eq(%2, %1) : (tensor<7x3xf32>, tensor<7x3xf32>) -> tensor<i1>
    return %3 : tensor<i1>
  }
  func.func private @inputs() -> (tensor<7x3x4xf32>, tensor<7x4xf32>) {
    %0 = stablehlo.constant dense<[[[1.35133195, -5.71631193, -6.74349212, 2.61048651], [1.26206768, 4.55344439, 0.246371597, -2.63304973], [-1.78180349, -2.99542785, -0.0884916782, -0.0295261722]], [[1.49186909, -1.15890384, 3.49563313, -1.8040663], [5.38366795, 1.71738815, 1.00890911, -0.0464559495], [-2.4610498, 2.73178959, 5.55472469, -2.7952826]], [[1.69574761, 0.0350769423, -5.55215073, 3.62729168], [-2.39658904, 5.77599955, 1.06865561, 6.70393896], [0.344028592, 2.33849287, -0.442372143, -2.87613678]], [[3.78947687, 4.27769947, -3.56895924, 3.10275888], [2.36256957, 5.08172798, -3.71159339, 6.82747412], [5.423944, 0.747435748, 1.77047622, 1.27210152]], [[-1.33784354, 2.85373712, -4.22396135, 0.580049872], [0.822635829, -5.79532242, 4.28838587, -2.64074326], [-1.4678371, -3.65136957, 2.5393908, 1.07987571]], [[-0.0888238251, 0.762101412, 1.46814942, 1.67757106], [-2.387580e+00, 2.11811543, -0.651506721, 4.0661912], [-3.15953088, 0.152244106, -2.96065784, -0.106662937]], [[1.37289393, 0.441721261, -2.06796718, 2.07551861], [-2.73915172, -1.59267759, 1.68253577, -0.569524825], [0.247259066, 1.72439718, -2.2237072, -2.664390e+00]]]> : tensor<7x3x4xf32>
    %1 = stablehlo.constant dense<[[2.99587703, -2.86951041, 2.65227723, -3.70346808], [0.90626955, -0.115028374, -1.34519243, 0.0679493099], [1.35506535, -1.79579926, 4.67940044, 3.97634268], [-0.665929079, -1.70369053, 4.42904854, -0.994511246], [0.82091552, -3.17175031, 3.38279605, -2.44436431], [-2.76068211, 4.59384203, -2.90148973, -5.41029119], [0.762748539, 1.42355561, -0.251334101, 0.224907547]]> : tensor<7x4xf32>
    return %0, %1 : tensor<7x3x4xf32>, tensor<7x4xf32>
  }
  func.func private @expected() -> tensor<7x3xf32> {
    %0 = stablehlo.constant dense<[[-7.10202312, 1.11970556, 3.13199186], [-3.33954191, 3.32117271, -10.2067194], [-9.32252311, 18.037756, -17.2398243], [-28.7042198, -33.4598236, 1.69104457], [-25.8562508, 40.0183029, 16.3268929], [-9.5897808, -3.78730154, 18.5892429], [2.66253805, -4.90751839, 2.60302377]]> : tensor<7x3xf32>
    return %0 : tensor<7x3xf32>
  }
}

